{% extends 'base.html' %}
{% load static %}

{% block title %}Booking Management - Wond'r NEUB{% endblock %}

{% block content %}
<div class="admin_dashboard">
    <!-- Header Section -->
    <div class="admin_header">
        <div class="admin_title">
            <h1>üìä Booking Dashboard</h1>
            <p>Manage all study tour bookings in one place</p>
        </div>
        <div class="admin_actions">
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-success" onclick="exportData()">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick_stats">
        <div class="stat_card total">
            <div class="stat_icon">üìã</div>
            <div class="stat_info">
                <div class="stat_number">{{ total_bookings }}</div>
                <div class="stat_label">Total Bookings</div>
            </div>
        </div>
        
        <div class="stat_card pending">
            <div class="stat_icon">‚è≥</div>
            <div class="stat_info">
                <div class="stat_number">{{ pending_count }}</div>
                <div class="stat_label">Pending</div>
            </div>
            {% if pending_count > 0 %}
            <div class="stat_alert">Needs Action</div>
            {% endif %}
        </div>
        
        <div class="stat_card confirmed">
            <div class="stat_icon">‚úÖ</div>
            <div class="stat_info">
                <div class="stat_number">{{ confirmed_count }}</div>
                <div class="stat_label">Confirmed</div>
            </div>
        </div>
        
        <div class="stat_card cancelled">
            <div class="stat_icon">‚ùå</div>
            <div class="stat_info">
                <div class="stat_number">{{ cancelled_count }}</div>
                <div class="stat_label">Cancelled</div>
            </div>
        </div>
    </div>

    <!-- Simple Filters -->
    <div class="simple_filters">
        <div class="filter_card">
            <h3>üîç Filter Bookings</h3>
            <form method="GET" class="filter_form">
                <div class="filter_row">
                    <input type="text" name="search" placeholder="Search by student name or email..." 
                           value="{{ search_query }}" class="search_box">
                    
                    <select name="status">
                        <option value="">All Status</option>
                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Confirmed</option>
                        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                    
                    <button type="submit" class="btn btn-filter">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                    
                    {% if search_query or status_filter %}
                    <a href="{% url 'admin_booking_management' %}" class="btn btn-clear">
                        <i class="fas fa-times"></i> Clear Filters
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Actions -->
    {% if pending_count > 0 %}
    <div class="quick_actions">
        <div class="action_card">
            <h3>üöÄ Quick Actions</h3>
            <div class="action_buttons">
                {% if pending_count > 0 %}
                <form method="POST" action="{% url 'approve_all_pending' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="action_btn approve_all" onclick="return confirm('Approve all {{ pending_count }} pending bookings?')">
                        <i class="fas fa-check-circle"></i>
                        <span>Approve All Pending ({{ pending_count }})</span>
                    </button>
                </form>
                {% endif %}
                
                <button class="action_btn send_reminders" onclick="sendPendingReminders()">
                    <i class="fas fa-bell"></i>
                    <span>Send Reminders</span>
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Bookings List -->
    <div class="bookings_list">
        <div class="list_header">
            <h3>üìã Recent Bookings</h3>
            <div class="list_controls">
                <span class="results_count">Showing {{ bookings|length }} of {{ total_bookings }} bookings</span>
            </div>
        </div>

        {% if bookings %}
        <div class="bookings_grid">
            {% for booking in bookings %}
            <div class="booking_card status-{{ booking.status }}">
                <div class="booking_header">
                    <div class="booking_id">#{{ booking.id }}</div>
                    <div class="booking_status">
                        <span class="status-badge {{ booking.status }}">
                            {{ booking.get_status_display }}
                        </span>
                    </div>
                </div>
                
                <div class="booking_body">
                    <div class="student_info">
                        <div class="student_avatar">
                            {{ booking.user.first_name|first|upper }}{{ booking.user.last_name|first|upper }}
                        </div>
                        <div class="student_details">
                            <div class="student_name">
                                {{ booking.user.get_full_name|default:booking.user.username }}
                            </div>
                            <div class="student_email">{{ booking.user.email }}</div>
                            <div class="booking_date">
                                <i class="fas fa-clock"></i> {{ booking.booking_date|date:"M d, Y H:i" }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="tour_info">
                        <h4>{{ booking.study_tour.name }}</h4>
                        <div class="tour_dates">
                            <i class="fas fa-calendar"></i>
                            {{ booking.tour_date.start_date|date:"M d, Y" }} - {{ booking.tour_date.end_date|date:"M d, Y" }}
                        </div>
                        <div class="tour_price">
                            <i class="fas fa-tag"></i>
                            BDT {{ booking.total_price }}
                        </div>
                        <div class="tour_slots">
                            <i class="fas fa-users"></i>
                            {{ booking.tour_date.available_slots }} slots available
                        </div>
                        {% if booking.special_requirements %}
                        <div class="special_requirements" onclick="showSpecialRequirements('{{ booking.special_requirements|escapejs }}')">
                            <i class="fas fa-sticky-note"></i>
                            Has Special Requirements
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="booking_footer">
                    <div class="booking_meta">
                        <div class="meta_item">
                            <i class="fas fa-id-card"></i>
                            User ID: {{ booking.user.id }}
                        </div>
                        <div class="meta_item">
                            <i class="fas fa-hashtag"></i>
                            Tour ID: {{ booking.study_tour.id }}
                        </div>
                    </div>
                    <div class="booking_actions">
                        {% if booking.status == 'pending' %}
                        <form method="POST" action="{% url 'approve_booking' booking.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Approve booking #{{ booking.id }}?')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        </form>
                        {% elif booking.status == 'confirmed' %}
                        <form method="POST" action="{% url 'pending_booking' booking.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('Set booking #{{ booking.id }} back to pending?')">
                                <i class="fas fa-clock"></i> To Pending
                            </button>
                        </form>
                        {% elif booking.status == 'cancelled' %}
                        <form method="POST" action="{% url 'restore_booking' booking.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-info btn-sm" onclick="return confirm('Restore booking #{{ booking.id }} to pending status?')">
                                <i class="fas fa-undo"></i> Restore
                            </button>
                        </form>
                        {% endif %}
                        
                        <button class="btn btn-info btn-sm" onclick="viewDetails({{ booking.id }}, '{{ booking.user.get_full_name|default:booking.user.username|escapejs }}', '{{ booking.user.email|escapejs }}', '{{ booking.study_tour.name|escapejs }}', '{{ booking.tour_date.start_date|date:"M d, Y" }}', '{{ booking.tour_date.end_date|date:"M d, Y" }}', '{{ booking.total_price }}', '{{ booking.status }}', '{{ booking.booking_date|date:"M d, Y H:i" }}', '{{ booking.special_requirements|default:"None"|escapejs }}', '{{ booking.tour_date.available_slots }}')">
                            <i class="fas fa-eye"></i> Details
                        </button>
                        
                        {% if booking.status != 'cancelled' %}
                        <button class="btn btn-warning btn-sm" onclick="contactStudent({{ booking.id }}, '{{ booking.user.get_full_name|default:booking.user.username|escapejs }}', '{{ booking.user.email|escapejs }}')">
                            <i class="fas fa-envelope"></i> Contact
                        </button>
                        
                        <form method="POST" action="{% url 'cancel_booking_admin' booking.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Cancel booking #{{ booking.id }}? This will free up the slot.')">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </form>
                        {% else %}
                        <form method="POST" action="{% url 'delete_booking' booking.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Permanently delete booking #{{ booking.id }}? This action cannot be undone.')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty_state">
            <div class="empty_icon">üì≠</div>
            <h3>No bookings found</h3>
            <p>
                {% if search_query or status_filter %}
                No bookings match your current search criteria.
                {% else %}
                No bookings have been made yet.
                {% endif %}
            </p>
            {% if search_query or status_filter %}
            <a href="{% url 'admin_booking_management' %}" class="btn btn-primary">
                <i class="fas fa-refresh"></i> Clear Filters
            </a>
            {% endif %}
        </div>
        {% endif %}

        <!-- Simple Pagination -->
        {% if bookings.has_other_pages %}
        <div class="simple_pagination">
            {% if bookings.has_previous %}
                <a href="?page={{ bookings.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page_btn">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            {% endif %}
            
            <span class="page_info">
                Page {{ bookings.number }} of {{ bookings.paginator.num_pages }}
            </span>
            
            {% if bookings.has_next %}
                <a href="?page={{ bookings.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page_btn">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Status Change Modal -->
<div id="statusModal" class="modal">
    <div class="modal_content status_modal">
        <div class="modal_header">
            <h3 id="statusModalTitle">Change Booking Status</h3>
            <span class="close" onclick="closeStatusModal()">&times;</span>
        </div>
        <div class="modal_body" id="statusModalBody">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<!-- Detailed Modal -->
<div id="detailedModal" class="modal">
    <div class="modal_content detailed_modal">
        <div class="modal_header">
            <h3 id="modalTitle">üìã Booking Details</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal_body" id="modalBody">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<!-- Special Requirements Modal -->
<div id="requirementsModal" class="modal">
    <div class="modal_content requirements_modal">
        <div class="modal_header">
            <h3>üìù Special Requirements</h3>
            <span class="close" onclick="closeRequirementsModal()">&times;</span>
        </div>
        <div class="modal_body" id="requirementsBody">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<style>
.admin_dashboard {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.admin_header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 30px;
    border-radius: 15px;
    color: white;
}

.admin_title h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
}

.admin_title p {
    margin: 10px 0 0 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.admin_actions {
    display: flex;
    gap: 15px;
}

/* Quick Stats */
.quick_stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat_card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 20px;
    border-left: 5px solid #667eea;
    position: relative;
    overflow: hidden;
}

.stat_card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #667eea, transparent);
}

.stat_card.pending {
    border-left-color: #f39c12;
}

.stat_card.confirmed {
    border-left-color: #27ae60;
}

.stat_card.cancelled {
    border-left-color: #e74c3c;
}

.stat_icon {
    font-size: 2.5rem;
}

.stat_info {
    flex: 1;
}

.stat_number {
    font-size: 2.2rem;
    font-weight: 700;
    color: #2c3e50;
    line-height: 1;
}

.stat_label {
    font-size: 1rem;
    color: #7f8c8d;
    margin-top: 5px;
}

.stat_alert {
    background: #e74c3c;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

/* Filters */
.simple_filters {
    margin-bottom: 30px;
}

.filter_card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.filter_card h3 {
    margin: 0 0 20px 0;
    color: #2c3e50;
}

.filter_row {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.search_box {
    flex: 1;
    min-width: 250px;
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.search_box:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter_row select {
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    background: white;
    min-width: 150px;
}

/* Quick Actions */
.quick_actions {
    margin-bottom: 30px;
}

.action_card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.action_card h3 {
    margin: 0 0 20px 0;
    color: #2c3e50;
}

.action_buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.action_btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.approve_all {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
}

.send_reminders {
    background: linear-gradient(135deg, #f39c12, #f1c40f);
    color: white;
}

.action_btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.action_btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Bookings List */
.bookings_list {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.list_header {
    padding: 25px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.list_header h3 {
    margin: 0;
    color: #2c3e50;
}

.results_count {
    color: #7f8c8d;
    font-size: 0.9rem;
}

/* Bookings Grid */
.bookings_grid {
    padding: 20px;
    display: grid;
    gap: 20px;
}

.booking_card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 25px;
    transition: all 0.3s ease;
    background: white;
}

.booking_card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.booking_card.status-pending {
    border-left: 5px solid #f39c12;
}

.booking_card.status-confirmed {
    border-left: 5px solid #27ae60;
}

.booking_card.status-cancelled {
    border-left: 5px solid #e74c3c;
    opacity: 0.8;
}

.booking_header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.booking_id {
    font-weight: 700;
    color: #2c3e50;
    font-size: 1.1rem;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.pending {
    background: #f39c12;
    color: white;
}

.status-badge.confirmed {
    background: #27ae60;
    color: white;
}

.status-badge.cancelled {
    background: #e74c3c;
    color: white;
}

.booking_body {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 30px;
    margin-bottom: 20px;
}

.student_info {
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

.student_avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
}

.student_name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.student_email {
    color: #7f8c8d;
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.booking_date {
    color: #95a5a6;
    font-size: 0.8rem;
}

.tour_info h4 {
    margin: 0 0 15px 0;
    color: #2c3e50;
}

.tour_dates, .tour_price, .tour_slots {
    margin-bottom: 8px;
    color: #7f8c8d;
    font-size: 0.9rem;
}

.special_requirements {
    color: #e67e22;
    cursor: pointer;
    font-size: 0.9rem;
    margin-top: 10px;
}

.special_requirements:hover {
    text-decoration: underline;
}

.booking_footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}

.booking_meta {
    display: flex;
    gap: 20px;
}

.meta_item {
    font-size: 0.8rem;
    color: #95a5a6;
}

.booking_actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 0.8rem;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-success {
    background: #27ae60;
    color: white;
}

.btn-warning {
    background: #f39c12;
    color: white;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-filter {
    background: #6c757d;
    color: white;
}

.btn-clear {
    background: #95a5a6;
    color: white;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Empty State */
.empty_state {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
}

.empty_icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.empty_state h3 {
    margin: 0 0 10px 0;
    color: #2c3e50;
}

/* Pagination */
.simple_pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding: 30px;
    border-top: 1px solid #e9ecef;
}

.page_btn {
    padding: 10px 20px;
    background: #667eea;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.page_btn:hover {
    background: #5a6fd8;
    transform: translateY(-1px);
}

.page_info {
    color: #7f8c8d;
    font-weight: 600;
}

/* Modals */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal_content {
    background-color: white;
    margin: 5% auto;
    border-radius: 15px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.status_modal {
    width: 90%;
    max-width: 500px;
}

.detailed_modal {
    width: 90%;
    max-width: 700px;
}

.requirements_modal {
    width: 90%;
    max-width: 500px;
}

.modal_header {
    padding: 25px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal_header h3 {
    margin: 0;
    color: #2c3e50;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease;
}

.close:hover {
    color: #e74c3c;
}

.modal_body {
    padding: 25px;
    max-height: 70vh;
    overflow-y: auto;
}

/* Status Options */
.status-options {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin: 20px 0;
}

.status-option {
    padding: 20px;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    font-weight: 600;
}

.status-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

.status-option.pending {
    border-color: #f39c12;
    background: rgba(243, 156, 18, 0.05);
}

.status-option.confirmed {
    border-color: #27ae60;
    background: rgba(39, 174, 96, 0.05);
}

.status-option.cancelled {
    border-color: #e74c3c;
    background: rgba(231, 76, 60, 0.05);
}

.status-option.selected {
    border-width: 3px;
    transform: scale(1.02);
}

/* Responsive Design */
@media (max-width: 768px) {
    .admin_header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }
    
    .admin_actions {
        justify-content: center;
    }
    
    .quick_stats {
        grid-template-columns: 1fr;
    }
    
    .filter_row {
        flex-direction: column;
    }
    
    .search_box {
        min-width: auto;
    }
    
    .booking_body {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .booking_footer {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .booking_actions {
        justify-content: center;
    }
    
    .simple_pagination {
        flex-direction: column;
        gap: 15px;
    }
    
    .modal_content {
        margin: 10% auto;
        width: 95%;
    }
}

@media (max-width: 480px) {
    .admin_dashboard {
        padding: 10px;
    }
    
    .admin_title h1 {
        font-size: 2rem;
    }
    
    .stat_card {
        padding: 20px;
    }
    
    .stat_number {
        font-size: 1.8rem;
    }
    
    .booking_card {
        padding: 20px;
    }
    
    .action_buttons {
        flex-direction: column;
    }
    
    .action_btn {
        justify-content: center;
    }
}
</style>

<script>
// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Modal functions
function openModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('detailedModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('detailedModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function openStatusModal(title, content) {
    document.getElementById('statusModalTitle').textContent = title;
    document.getElementById('statusModalBody').innerHTML = content;
    document.getElementById('statusModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function openRequirementsModal(content) {
    document.getElementById('requirementsBody').innerHTML = '<p style="white-space: pre-wrap; line-height: 1.6; padding: 20px; background: #f8f9fa; border-radius: 8px;">' + content + '</p>';
    document.getElementById('requirementsModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeRequirementsModal() {
    document.getElementById('requirementsModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Show special requirements
function showSpecialRequirements(requirements) {
    openRequirementsModal(requirements);
}

// Refresh data
function refreshData() {
    window.location.reload();
}

// Export data (placeholder)
function exportData() {
    alert('Export functionality will be implemented soon!');
}

// Send reminders (placeholder)
function sendPendingReminders() {
    alert('Reminder functionality will be implemented soon!');
}

// Contact student
function contactStudent(bookingId, studentName, studentEmail) {
    const subject = `Regarding Your Study Tour Booking #${bookingId}`;
    const body = `Dear ${studentName},\n\nI am writing to you regarding your study tour booking (ID: ${bookingId}).\n\n`;
    
    const mailtoLink = `mailto:${studentEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailtoLink, '_blank');
}

// Open email client
function openEmailClient(email, subject, body) {
    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailtoLink, '_blank');
}

// View booking details
function viewDetails(bookingId, studentName, studentEmail, tourName, startDate, endDate, price, status, bookingDate, specialRequirements, availableSlots) {
    const statusDisplay = {
        'pending': { class: 'status-pending', text: 'Pending', color: '#f39c12' },
        'confirmed': { class: 'status-confirmed', text: 'Confirmed', color: '#27ae60' },
        'cancelled': { class: 'status-cancelled', text: 'Cancelled', color: '#e74c3c' }
    };
    
    const statusInfo = statusDisplay[status] || statusDisplay.pending;
    
    const content = `
        <div style="line-height: 1.6;">
            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üë§ Student Information</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Full Name</strong><br>
                        <span style="color: #2c3e50; font-weight: 600;">${studentName}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Email</strong><br>
                        <span style="color: #2c3e50; font-weight: 600;">${studentEmail}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Booking Date</strong><br>
                        <span style="color: #2c3e50; font-weight: 600;">${bookingDate}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Booking ID</strong><br>
                        <span style="color: #2c3e50; font-weight: 600;">#${bookingId}</span>
                    </div>
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üéØ Tour Information</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Tour Name</strong><br>
                        <span style="color: #2c3e50; font-weight: 600;">${tourName}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Duration</strong><br>
                        <span style="color: #2c3e50; font-weight: 600;">${startDate} to ${endDate}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Price</strong><br>
                        <span style="color: #2c3e50; font-weight: 600;">BDT ${parseInt(price).toLocaleString()}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Available Slots</strong><br>
                        <span style="color: #2c3e50; font-weight: 600;">${availableSlots}</span>
                    </div>
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üìä Booking Status</h4>
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Current Status</strong><br>
                        <span class="status-display ${statusInfo.class}" style="padding: 8px 16px; border-radius: 20px; color: white; background: ${statusInfo.color}; font-weight: 600;">
                            ${statusInfo.text}
                        </span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 0.9rem;">Special Requirements</strong><br>
                        <span style="color: #2c3e50; font-weight: 600;">${specialRequirements === 'None' ? 'None provided' : 'Provided'}</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-warning" onclick="contactStudent(${bookingId}, '${studentName}', '${studentEmail}')">
                    <i class="fas fa-envelope"></i> Contact Student
                </button>
                <button class="btn btn-info" onclick="changeBookingStatus(${bookingId}, '${studentName}', '${status}')">
                    <i class="fas fa-exchange-alt"></i> Change Status
                </button>
                <button class="btn btn-clear" onclick="closeModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    `;
    openModal('Booking Details', content);
}

// Change booking status
function changeBookingStatus(bookingId, studentName, currentStatus) {
    closeModal();
    
    const statusOptions = [
        { value: 'pending', label: '‚è≥ Pending', description: 'Booking is awaiting approval' },
        { value: 'confirmed', label: '‚úÖ Confirmed', description: 'Booking is approved and confirmed' },
        { value: 'cancelled', label: '‚ùå Cancelled', description: 'Booking is cancelled' }
    ];
    
    let statusOptionsHTML = '';
    statusOptions.forEach(option => {
        const isCurrent = option.value === currentStatus;
        statusOptionsHTML += `
            <div class="status-option ${option.value} ${isCurrent ? 'selected' : ''}" 
                 onclick="selectStatus('${option.value}')" 
                 style="${isCurrent ? 'border-color: ' + (option.value === 'pending' ? '#f39c12' : option.value === 'confirmed' ? '#27ae60' : '#e74c3c') + ';' : ''}">
                <div style="font-size: 1.2rem; margin-bottom: 5px;">${option.label}</div>
                <div style="font-size: 0.8rem; color: #7f8c8d;">${option.description}</div>
                ${isCurrent ? '<div style="font-size: 0.7rem; color: #27ae60; margin-top: 5px;">‚úì Current Status</div>' : ''}
            </div>
        `;
    });
    
    const content = `
        <div style="line-height: 1.6;">
            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Change Booking Status</h4>
                <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">
                    Booking #${bookingId} - ${studentName}
                </p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <strong style="color: #7f8c8d; font-size: 0.9rem;">Select New Status:</strong>
                <div class="status-options" id="statusOptions">
                    ${statusOptionsHTML}
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="updateBookingStatus(${bookingId})" id="updateStatusBtn" disabled>
                    <i class="fas fa-save"></i> Update Status
                </button>
                <button class="btn btn-clear" onclick="closeStatusModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
            
            <input type="hidden" id="selectedStatus" value="">
        </div>
    `;
    
    setTimeout(() => {
        openStatusModal('Change Booking Status', content);
    }, 300);
}

// Select status
function selectStatus(status) {
    document.getElementById('selectedStatus').value = status;
    
    const options = document.querySelectorAll('.status-option');
    options.forEach(option => {
        option.classList.remove('selected');
    });
    
    event.target.closest('.status-option').classList.add('selected');
    
    document.getElementById('updateStatusBtn').disabled = false;
}

// Update booking status
function updateBookingStatus(bookingId) {
    const newStatus = document.getElementById('selectedStatus').value;
    
    if (!newStatus) {
        alert('‚ùå Please select a status first.');
        return;
    }
    
    const updateBtn = document.getElementById('updateStatusBtn');
    const originalText = updateBtn.innerHTML;
    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    updateBtn.disabled = true;
    
    let url = '';
    
    if (newStatus === 'pending') {
        url = '{% url "pending_booking" 0 %}'.replace('0', bookingId);
    } else if (newStatus === 'confirmed') {
        url = '{% url "approve_booking" 0 %}'.replace('0', bookingId);
    } else if (newStatus === 'cancelled') {
        url = '{% url "cancel_booking_admin" 0 %}'.replace('0', bookingId);
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = url;
    form.style.display = 'none';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = getCookie('csrftoken');
    form.appendChild(csrfToken);
    
    document.body.appendChild(form);
    form.submit();
}

// Close modals when clicking outside
window.onclick = function(event) {
    const statusModal = document.getElementById('statusModal');
    const detailedModal = document.getElementById('detailedModal');
    const requirementsModal = document.getElementById('requirementsModal');
    
    if (event.target === statusModal) {
        closeStatusModal();
    }
    if (event.target === detailedModal) {
        closeModal();
    }
    if (event.target === requirementsModal) {
        closeRequirementsModal();
    }
}

// Close modals with escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
        closeStatusModal();
        closeRequirementsModal();
    }
});

// Export functions to global scope
window.refreshData = refreshData;
window.exportData = exportData;
window.sendPendingReminders = sendPendingReminders;
window.viewDetails = viewDetails;
window.showSpecialRequirements = showSpecialRequirements;
window.closeModal = closeModal;
window.closeStatusModal = closeStatusModal;
window.closeRequirementsModal = closeRequirementsModal;
window.contactStudent = contactStudent;
window.openEmailClient = openEmailClient;
window.changeBookingStatus = changeBookingStatus;
window.selectStatus = selectStatus;
window.updateBookingStatus = updateBookingStatus;
</script>
{% endblock %}